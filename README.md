# Simple Chat 需求规格说明书

## 1. 文档概况
- **版本：** 1.0.0
- **最后更新：** 2025-10-17
- **维护人：** 核心项目贡献者（应用、运维、测试）

## 2. 目的与范围
Simple Chat 是一款基于浏览器的实时聊天应用，面向轻量协作场景。本文档用于明确系统的功能性与非功能性需求，涵盖 Node.js/Socket.IO 服务端、单页 Web 客户端、静态资源及单实例部署的运维要求。

## 3. 术语与缩写
- **SPA：** 单页应用（Single Page Application），由 `/public` 目录下静态资源提供。
- **房间（Room）：** 聊天频道，使用字符串标识，默认值为 `public`。
- **在线人数（Presence）：** 房间内当前连接客户端数量。
- **表情资源（Emoji Asset）：** 位于 `/public/emojis` 的静态图片或消息中嵌入的远程图片。

## 4. 干系人
- **终端用户：** 进入浏览器聊天室进行沟通的用户。
- **会话发起人：** 创建临时房间并分享链接的用户。
- **运维人员：** 负责部署和监控 Node.js 服务的人员。
- **安全审核：** 关注输入净化、速率限制和应急响应的人员。

## 5. 用户画像与需求
- **访客用户：** 期望进入公共房间后即可实时聊天，使用表情并保持昵称。
- **主持人：** 需要临时创建私有房间、分发分享链接并关注参与人数。
- **管理员（规划中）：** 希望具备审计、消息管理能力（当前版本不实现）。

## 6. 系统概述
系统由 Express HTTP 服务器与 Socket.IO 双向通信组成。静态资源（`index.html`、`client.js`、`style.css`、表情图片）通过 Express 提供。客户端通过 WebSocket（必要时回退至长轮询）与服务器交换经净化的 HTML 片段。每个 socket 仅属于一个房间，昵称和房间信息保存在服务端内存。

## 7. 假设与依赖
- 运行环境需提供 Node.js 18+，客户端能够访问网络。
- 单实例部署，不考虑多节点房间同步。
- 浏览器需支持 ES2015、ContentEditable、FileReader API。
- 表情资源由人工维护，随应用一起部署。

## 8. 典型用例
1. **加入公共房间：** 用户访问 `/` 自动进入 `public` 房间并开始聊天。
2. **保存昵称：** 首次访问提示输入昵称并写入 `localStorage`。
3. **发送文本消息：** 用户提交格式化文本，服务器净化后广播给房间成员。
4. **发送图片：** 用户粘贴或拖放图片，客户端转换为 Data URL 后发送。
5. **选择表情：** 用户点击从 `/api/emojis` 加载的按钮，将表情插入输入框。
6. **创建私有房间：** 用户点击“新建聊天”，生成唯一房间标识，尝试打开新标签并复制分享链接。
7. **查看在线人数：** 用户实时接收 `presence:update` 事件了解在线人数。
8. **断线重连：** 网络中断后，Socket.IO 自动重连并重新加入原房间。

## 9. 功能需求
### 9.1 房间与在线管理
- FR-01：连接建立时服务器必须默认将 socket 加入 `public` 房间。
- FR-02：服务器必须支持客户端通过 `join` 事件切换房间并更新昵称。
- FR-03：服务器必须维护以内存 `Map` 形式存储的房间成员列表，键为 Socket ID。
- FR-04：房间成员变化时，服务器必须向该房间广播携带 `{count}` 的 `presence:update` 事件。

### 9.2 消息管线
- FR-05：客户端必须通过 `chat message` 事件发送已在本地净化的 HTML 字符串。
- FR-06：服务器必须拒绝空消息，并在广播前调用 `sanitizeHtml` 进行净化。
- FR-07：服务器广播消息前必须补充 `id`、`sender`、`senderId`、`timestamp` 字段。
- FR-08：客户端收到消息后必须再执行 `sanitizeIncomingHtml` 白名单过滤。
- FR-09：客户端必须区分本地用户与其他用户消息的视觉样式。
- FR-10：当消息时间戳相差不少于 5 分钟时必须插入时间分隔条。

### 9.3 丰富媒体
- FR-11：客户端必须支持粘贴或拖放图片，且仅接受图片 MIME 类型的 Data URL。
- FR-12：客户端必须丢弃 `src` 不以 `data:`、`http`、`https`、`/` 开头的图片。
- FR-13：服务器必须提供 `GET /api/emojis` 返回可用表情路径列表。
- FR-14：客户端必须将表情列表渲染为可点击按钮，点击后插入消息输入框。

### 9.4 昵称持久化
- FR-15：当 `localStorage.simpleChatNickname` 为空时，客户端必须提示输入昵称。
- FR-16：客户端必须将昵称保存在本地并在 `join` 事件中携带。
- FR-17：服务器必须在房间成员列表中更新最新昵称信息。

### 9.5 房间创建流程
- FR-18：客户端必须使用 `crypto.randomUUID`（或时间戳+随机数兜底）生成唯一房间 ID。
- FR-19：客户端必须尝试在新标签或新窗口打开房间链接并复制到剪贴板。
- FR-20：若浏览器阻止弹窗，客户端必须提示用户复制生成的房间链接。

### 9.6 错误处理与健壮性
- FR-21：当输入框既无文本也无图片时，客户端必须禁用发送按钮。
- FR-22：输入内容变化后，客户端必须刷新发送按钮状态。
- FR-23：Socket.IO 断开连接时，客户端必须将在线人数显示为 0。
- FR-24：服务器应在启动时输出监听端口，并记录严重错误日志。

## 10. 非功能需求
- **可用性：** 单实例部署目标可用性为 99%，不提供内置故障转移。
- **延迟：** 局域网消息往返应小于 300 ms，广域网应小于 1 s。
- **容量：** 单实例应支持 200 个并发 socket；超出时需后续扩容设计。
- **安全：** 必须清除 `<script>` 标签与内联事件属性，仅存储内存态数据，无凭证信息。
- **隐私：** 不持久化消息历史，日志不得包含敏感内容。
- **可访问性：** 界面应支持键盘操作，核心控件需具备焦点提示。
- **国际化：** 基准语言为简体中文，其他语言待后续规划。
- **浏览器支持：** 最新版本 Chrome、Firefox、Edge、Safari 桌面浏览器。

## 11. 数据模型
- **Socket 会话：** `{ socketId, displayName, roomId }`，存于 `roomMembers` 映射中。
- **消息载荷：** `{ id, senderId, sender, html, timestamp }`，广播给房间内客户端。
- **在线人数载荷：** `{ count }`，按房间推送。
- **表情列表：** 字符串数组，指向 `/public` 下静态资源路径。

## 12. 外部接口
- **HTTP：**
	- `GET /` → 返回 `public/index.html`。
	- `GET /api/emojis` → 返回表情资源路径的 JSON 数组。
	- `/public/*` → 静态资源服务。
- **WebSocket（Socket.IO）：**
	- 事件：`join`、`chat message`、`presence:update`（服务器推送）以及 `connect`、`disconnect`。

## 13. 安全注意事项
- 客户端在发送前必须移除所有脚本与内联事件属性。
- 服务器必须对 HTML 内容进行净化，并可在后续引入基于 socket 的速率限制。
- 剪贴板 Data URL 仅驻留内存，不写入磁盘。
- 私有房间依赖链接唯一性，无鉴权机制，分享链接需谨慎。

## 14. 运维要求
- 使用 `node index.js` 启动应用，可通过环境变量 `PORT` 指定端口。
- 监控需覆盖进程存活状态与未捕获异常。
- 系统无状态，无需备份，重启即清空房间数据。
- 升级需重启服务，客户端将在 Socket.IO 自动重连后恢复对话。

## 15. 测试策略
- **单元测试（规划中）：** 净化工具、房间成员辅助函数等。
- **集成测试：** Socket.IO 事件流、表情 API 响应、昵称持久化流程。
- **手工验证：** 跨浏览器消息互通、图片粘贴与拖放、私有房间创建、断线重连。

## 16. 未决问题与后续改进
- 消息历史持久化与管理员工具。
- 私有房间的身份认证与权限控制。
- 图片大小限制、MIME 校验、缩略图生成。
- 多实例扩展方案（粘性会话或共享状态存储）。
- 移动端体验优化（软键盘适配）。

## 17. 验收标准
- 用户可以在各房间实时收发经净化的消息。
- 用户昵称在浏览器会话之间保持一致。
- 表情选择器展示可用资源并可插入消息。
- 在线人数显示准确反映当前房间连接数。
- 私有房间链接按预期生成、打开并可复制分享。
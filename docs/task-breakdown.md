# Simple Chat 任务拆解书

## 1. 概述
- **目标：** 将需求规格与系统设计转化为可执行任务，确保在可控周期内交付稳定可用的 Simple Chat。
- **版本范围：** 对应《Simple Chat 需求规格说明书》1.0.0 与《Simple Chat 系统设计文档》初始版本。
- **交付周期假设：** 2 周 Sprint，可按需调整。

## 2. 里程碑规划
1. **M1：基础通信与房间管理可用**
   - 完成 Socket.IO 基础通信、房间加入/切换、在线人数统计。
   - 交付可访问的公共房间聊天最小可行产品。
2. **M2：富文本输入与表情支持**
   - 实现文本编辑、图片拖拽粘贴、表情面板。
   - 确保消息净化与展示逻辑完整。
3. **M3：私有房间与用户体验完善**
   - 实现房间链接创建、昵称持久化、时间分隔、自动滚动等体验细节。
4. **M4：测试与运维准备**
   - 完成必要的测试、部署脚本（如需要）、监控与文档验收。

## 3. 任务分解
### 3.1 服务器端任务
1. **基础服务搭建**
   - 初始化 Express 应用，配置静态资源目录。
   - 集成 Socket.IO，处理 `connection`、`disconnect` 生命周期。
2. **房间管理功能**
   - 实现房间成员 Map 结构及辅助函数（`ensureRoom`、`removeFromRoom`、`emitPresence`）。
   - 处理 `join` 事件：默认房间、昵称更新、离开旧房间逻辑。
3. **消息广播与净化**
   - 实现 `sanitizeHtml`，剔除脚本与内联事件。
   - 构造消息对象（ID、昵称、时间戳）并广播。
   - 忽略空消息、异常 payload。
4. **Emoji API**
   - 实现 `GET /api/emojis`，遍历 `/public/emojis`，返回合法图片路径。
   - 处理文件系统异常并返回空数组。
5. **运维支撑**
   - 日志输出监听端口与错误信息。
   - 支持 `PORT` 环境变量。

### 3.2 客户端任务
1. **连接与状态管理**
   - 通过 Socket.IO 客户端建立连接，封装 `connect`/`disconnect`/`presence:update` 事件处理。
   - 管理在线人数显示。
2. **昵称与房间初始化**
   - 从 URL 解析房间 ID，默认使用 `public`。
   - 检查 `localStorage`，提示录入昵称并缓存。
   - 首次连线时发送 `join` 事件。
3. **消息编辑与发送**
   - 构建 ContentEditable 输入框，支持回车发送、Shift+Enter 换行。
   - `prepareOutgoingHtml`：复制节点、移除危险属性、识别纯文本/图片。
   - 控制发送按钮启用/禁用。
4. **消息渲染**
   - `appendMessage`：插入消息项，区分自己与他人样式。
   - `sanitizeIncomingHtml`：白名单过滤标签和属性。
   - 自动滚动逻辑与时间分隔条插入。
5. **图片与表情处理**
   - 监听粘贴、拖拽读取图片文件，转换为 Data URL。
   - 调用 `/api/emojis`，渲染按钮，点击插入图片节点。
6. **私有房间创建**
   - `createRoomButton`：生成唯一房间 token，拼接链接。
   - 尝试新标签打开，复制链接，失败时提醒。

### 3.3 样式与体验任务
- 设计聊天界面布局（头部、消息区、输入区、表情面板）。
- 实现消息泡泡、时间分隔、滚动条等视觉效果。
- 响应式布局：适配窄屏（≤768px）时的高度与按钮布局。
- 状态提示（按钮 hover、禁用、Emoji 空状态）。

### 3.4 测试与质量保障
1. **单元测试（可选）**
   - 净化函数、房间管理方法。
2. **集成测试**
   - 使用 Socket.IO 测试客户端脚本验证消息广播、presence 更新。
   - 验证 Emoji API 在空目录或异常时返回正确结构。
3. **手工测试清单**
   - 多浏览器互通。
   - 断网重连流程。
   - 粘贴图片、拖拽图片、Emoji 插入。
   - 创建房间链接、复制、分享。

### 3.5 文档与运维交付
- 补充/维护 `README.md`（需求）、`docs/design.md`（设计）、`docs/task-breakdown.md`（本文件）。
- 编写启动说明、部署脚本（如需要）。
- 准备监控指标说明与日志采集策略建议。

## 4. 工作分配参考
| 角色 | 主要任务 | 预估工期 |
| --- | --- | --- |
| 前端工程师 | 客户端逻辑、样式、表情面板、房间创建体验 | 5~6 天 |
| 后端工程师 | Express/Socket.IO 服务、房间管理、Emoji API | 4~5 天 |
| 全栈工程师 | 协调端到端功能、部署与环境搭建 | 2 天 |
| 测试工程师 | 集成测试、手工用例执行、缺陷跟踪 | 2 天 |

> 注：工期基于单人日估算，可按团队实际能力调整，并允许并行推进。

## 5. 风险与应对
- **XSS 风险：** 强化净化流程，安排专项测试；必要时引入第三方库（如 DOMPurify）。
- **图片体积过大：** 规划限制文件大小或压缩策略；短期可通过文档提示控制使用场景。
- **房间状态丢失：** 单实例重启即清空；如需持久化需提前评估 Redis 等方案。
- **浏览器兼容性：** 针对 ContentEditable 与 Clipboard API 进行兼容测试。

## 6. 交付验收
- 所有功能满足验收标准，关键用户故事通过测试。
- 代码仓库包含最新文档、必要脚本，`README` 更新运行说明。
- 线上/测试环境部署成功，基本监控就绪。
- 缺陷跟踪表关闭所有阻塞级别问题。

---
本任务拆解书将随需求或设计调整而更新，建议每个迭代结束后回顾并修订。